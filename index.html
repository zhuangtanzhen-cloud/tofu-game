<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>éœ‰è±†è…æ‘Šä¸»æ¨¡æ‹Ÿå™¨</title>
    <!-- å¼•å…¥å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        /* ================= å…¨å±€é‡ç½® ================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #333;
            /* ä¿®æ”¹å­—ä½“ */
            font-family: "ZCOOL KuaiLe", "Microsoft YaHei", cursive, sans-serif;
            user-select: none; -webkit-user-select: none;
            touch-action: manipulation; /* æ”¹å–„è§¦æ‘¸ä½“éªŒ */
        }

        #gameContainer {
            position: relative; width: 100%; height: 100%;
            max-width: 600px; margin: 0 auto;
            background-image: url('img/bg_main.png'); 
            background-size: cover; background-position: center;
            overflow: hidden;
        }

        .game-btn {
            padding: 14px 36px; font-size: 20px; font-weight: bold;
            background-color: #ff9800; color: white;
            border: none; border-radius: 50px;
            box-shadow: 0 4px #e65100; cursor: pointer;
            z-index: 200; pointer-events: auto; transition: transform 0.1s;
            touch-action: manipulation;
        }
        .game-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .stage-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; }

        /* ================= Stage 1: å‰§æƒ… ================= */
        #tofuBoard {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 320px;
            background-image: url('img/tofu_raw.png');
            background-size: contain; background-repeat: no-repeat;
        }

        #customerHand {
            position: absolute; 
            right: -300px; 
            top: 50%; margin-top: -125px; 
            width: 250px; height: 250px;
            background-image: url('img/hand.png');
            background-size: contain; background-repeat: no-repeat;
            z-index: 20; 
        }
        
        .hand-anim-in { animation: handIn 3s ease-out forwards; }
        .hand-anim-out { transition: all 0.5s ease-in; right: -350px !important; }
        
        @keyframes handIn { 
            0% { right: -300px; }
            100% { right: 0; } /* è´´ç€å±å¹•è¾¹ç¼˜ */
        }

        /* ================= Stage 2: åˆ‡å‰² ================= */
        #cuttingArea {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; height: 350px;
        }
        #cuttingBoard {
            width: 100%; height: 100%; 
            background-image: url('img/tofu_raw.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        #cutCanvas { position: absolute; top: 0; left: 0; z-index: 55; touch-action: none; }

        /* ================= Stage 3: è£¹æ–™ ================= */
        #mixingPot {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            width: 380px; height: 380px;
            background-image: url('img/pot.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        
        .tofu-cube {
            width: 80px; height: 80px;
            position: absolute;
            background-image: url('img/tofu_piece.png');
            background-size: contain; background-repeat: no-repeat;
            background-color: transparent; 
            pointer-events: none; 
            transition: filter 0.3s;
        }

        .filter-wet { filter: sepia(0.5) brightness(0.9); } 
        .filter-red { filter: sepia(1) saturate(6) hue-rotate(-50deg) contrast(1.2); }
        
        .shake-inner { animation: rattle 0.2s infinite; }
        @keyframes rattle {
            0% { margin-left: 0; margin-top: 0; }
            25% { margin-left: 4px; margin-top: -4px; }
            50% { margin-left: -4px; margin-top: 4px; }
            75% { margin-left: 4px; margin-top: 4px; }
            100% { margin-left: 0; margin-top: 0; }
        }

        .shake-pot-anim { animation: shakePot 0.3s infinite; }
        @keyframes shakePot { 
            0% {transform:translate(-50%,-50%) rotate(0);} 
            25% {transform:translate(-52%,-48%) rotate(-3deg);} 
            75% {transform:translate(-48%,-52%) rotate(3deg);} 
        }

        /* è®¢å•æç¤º */
        #orderNote {
            position: absolute; 
            top: 140px;
            left: 50%; transform: translateX(-50%);
            background: #fff9c4; color: #333; padding: 12px 20px; font-size: 18px;
            font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); display: none;
            z-index: 100;
            border-radius: 10px;
            border: 2px dashed #ff9800;
            max-width: 90%;
            text-align: center;
        }

        /* éªŒè¯æç¤ºæ ‡ç­¾ */
        #validationTip {
            position: absolute; 
            top: 200px;
            left: 50%; transform: translateX(-50%);
            background: #ff5252; color: white; padding: 10px 20px; font-size: 16px;
            font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); display: none;
            z-index: 101;
            border-radius: 25px;
            border: 2px solid white;
            max-width: 90%;
            text-align: center;
            animation: bounceIn 0.5s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            70% { transform: translateX(-50%) scale(1.1); }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }

        /* è°ƒæ–™æ  */
        #seasoningBar {
            position: absolute; 
            bottom: 200px;
            width: 100%; display: flex; justify-content: center; gap: 15px;
            flex-wrap: wrap;
        }
        .seasoning-item {
            text-align: center; color: #fff; font-size: 16px; opacity: 0.7;
            text-shadow: 1px 1px 2px black; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center;
            touch-action: manipulation;
        }
        .seasoning-item img {
            width: 70px; height: 70px;
            display: block; margin-bottom: 5px;
            transition: transform 0.2s;
        }
        .seasoning-item.clickable { opacity: 1; cursor: pointer; }
        .seasoning-item.clickable img { animation: pulse 1s infinite; }
        .seasoning-item.selected { opacity: 1; filter: drop-shadow(0 0 10px gold); }
        .seasoning-item.selected img { transform: scale(1.2); animation: none; }
        @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }

        /* ================= Stage 4: è£…ç½ ================= */
        #s4-pot-area {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            width: 380px; height: 380px;
            background-image: url('img/pot.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }

        .pack-tofu {
            width: 80px; height: 80px;
            position: absolute; 
            background-image: url('img/tofu_piece.png');
            background-size: contain; background-repeat: no-repeat;
            background-color: transparent;
            touch-action: none;
        }
        .pack-tofu.dragging { z-index: 999; transform: scale(1.3); }

        /* ç½å­å®¹å™¨ */
        #oneJarContainer {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 220px; height: 330px;
            display: flex; justify-content: center; align-items: flex-end;
        }
        
        .jar-box {
            width: 100%; height: 100%; position: relative;
        }
        
        .jar-foreground {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('img/jar_square.png'); 
            background-size: 100% 100%;
            z-index: 20; pointer-events: none;
        }

        .jar-highlight {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 20px;
            box-shadow: 0 0 30px 10px gold;
            opacity: 0; transition: opacity 0.2s; z-index: 5;
        }
        .jar-box.highlight .jar-highlight { opacity: 0.6; }

        .jar-tofu-inner {
            position: absolute; 
            width: 60px; height: 60px;
            background-image: url('img/tofu_piece.png');
            background-size: contain; background-repeat: no-repeat;
            background-color: transparent;
            z-index: 10; 
        }

        /* ================= å¯¹è¯æ¡†æ ·å¼ ================= */
        #dialogueBox {
            position: absolute; 
            top: 80px;
            left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px;
            min-height: 140px;
            display: none; z-index: 400;
            font-size: 18px; color: #333;
            padding: 25px 30px 40px 30px;
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .dialogue-host {
            background-image: url('img/dialogue_host.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }
        
        .dialogue-customer {
            background-image: url('img/dialogue_customer.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        #dialogueText {
            margin: 0; line-height: 1.4;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.5);
            padding: 10px;
            max-width: 90%;
        }

        /* ç‚¹å‡»ç»§ç»­æç¤º */
        .click-hint {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #666;
            font-style: italic;
            animation: fadeInOut 1.5s infinite;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* ================= å…¶ä»–UIç»„ä»¶ ================= */
        #uiLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 300; background-color: rgba(0,0,0,0.8);
        }
        
        #progressContainer {
            position: absolute; top: 120px; left: 20%; width: 60%; height: 12px;
            background: rgba(0,0,0,0.5); border-radius: 6px; display: none; overflow: hidden;
        }
        #shakeProgressBar { width: 0; height: 100%; background: #76ff03; transition: width 0.1s; }
        #resultCard {
            background: #fff; width: 85%; padding: 30px; border-radius: 20px;
            text-align: center; display: none; box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        
        /* èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’® */
        #bgmControl {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px; background: rgba(0,0,0,0.5);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000; color: white; font-size: 24px;
            touch-action: manipulation;
        }

        /* ================= æ‰‹æœºé€‚é… ================= */
        @media (max-width: 480px) {
            .game-btn {
                padding: 12px 28px;
                font-size: 18px;
            }
            
            #cuttingArea, #mixingPot, #s4-pot-area {
                width: 300px !important;
                height: 300px !important;
            }
            
            #cutCanvas {
                width: 300px !important;
                height: 300px !important;
            }
            
            .seasoning-item img {
                width: 60px;
                height: 60px;
            }
            
            #dialogueBox {
                padding: 20px 25px 35px 25px;
                font-size: 16px;
                min-height: 120px;
            }
            
            #orderNote {
                font-size: 16px;
                padding: 10px 15px;
                top: 120px;
            }
            
            #validationTip {
                font-size: 14px;
                padding: 8px 16px;
                top: 180px;
            }
            
            #oneJarContainer {
                width: 200px;
                height: 300px;
            }
            
            .jar-tofu-inner {
                width: 55px;
                height: 55px;
            }
            
            #seasoningBar {
                bottom: 180px;
                gap: 10px;
            }
            
            #s3-guide {
                font-size: 20px !important;
                top: 30px !important;
            }
        }

        @media (max-width: 360px) {
            .seasoning-item img {
                width: 50px;
                height: 50px;
            }
            
            .game-btn {
                padding: 10px 24px;
                font-size: 16px;
            }
            
            #cuttingArea, #mixingPot, #s4-pot-area {
                width: 280px !important;
                height: 280px !important;
            }
            
            #seasoningBar {
                bottom: 160px;
            }
        }
    </style>
</head>
<body>

<div id="gameContainer">

    <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <div id="bgmControl" onclick="toggleBGM()">â™ª</div>

    <!-- STAGE 1 -->
    <div id="stage1" class="stage-layer">
        <div id="tofuBoard"></div>
        <div id="customerHand"></div>
    </div>

    <!-- STAGE 2 -->
    <div id="stage2" class="stage-layer">
        <div style="position:absolute; top:40px; width:100%; text-align:center; color:#fff; font-weight:bold; font-size:20px; text-shadow:1px 1px 2px black;">æ»‘åŠ¨åˆ‡å‰²è±†è… (è‡³å°‘4åˆ€)</div>
        <div id="cuttingArea">
            <div id="cuttingBoard"></div>
            <canvas id="cutCanvas" width="350" height="350"></canvas>
        </div>
        <button id="btn-finish-cut" class="game-btn" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); display:none;">åˆ‡å‰²å®Œæˆ</button>
    </div>

    <!-- STAGE 3 -->
    <div id="stage3" class="stage-layer">
        <div style="position:absolute; top:40px; width:100%; text-align:center; color:#ffecb3; font-weight:bold; font-size:22px; text-shadow:1px 1px 2px black;" id="s3-guide">æ­¥éª¤1: åŠ å…¥ç™½é…’</div>
        <div id="orderNote"></div>
        <!-- æ–°å¢éªŒè¯æç¤ºæ ‡ç­¾ -->
        <div id="validationTip"></div>
        
        <div id="progressContainer"><div id="shakeProgressBar"></div></div>
        
        <div id="mixingPot"></div>

        <!-- ç¡®è®¤æŒ‰é’®è°ƒæ•´åˆ°æ›´ä¸‹æ–¹ -->
        <button id="btn-confirm-mix" class="game-btn" style="position:absolute; bottom:100px; left:50%; transform:translateX(-50%); display:none;">ç¡®è®¤è°ƒé…</button>

        <div id="seasoningBar">
            <div class="seasoning-item" id="item-spirit"><img src="img/icon_wine.png">ç™½é…’</div>
            <div class="seasoning-item" id="item-pepper"><img src="img/icon_pepper.png">èŠ±æ¤’</div>
            <div class="seasoning-item" id="item-five"><img src="img/icon_five.png">äº”é¦™</div>
            <div class="seasoning-item" id="item-chili"><img src="img/icon_chili.png">è¾£æ¤’</div>
            <div class="seasoning-item" id="item-salt"><img src="img/icon_salt.png">é£Ÿç›</div>
        </div>
    </div>

    <!-- STAGE 4: è£…ç½ -->
    <div id="stage4" class="stage-layer">
        <div style="position:absolute; top:40px; width:100%; text-align:center; color:#fff; font-weight:bold; font-size:20px; text-shadow:1px 1px 2px black;">æ‹–æ‹½å…¥ç½</div>
        
        <div id="s4-pot-area"></div>
        
        <div id="oneJarContainer">
            <div class="jar-box" id="theJar">
                <div class="jar-highlight"></div>
                <div class="jar-foreground"></div>
            </div>
        </div>

        <button id="btn-finish-pack" class="game-btn" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%);">å®ŒæˆåŒ…è£…</button>
    </div>

    <!-- å¯¹è¯æ¡† -->
    <div id="dialogueBox">
        <p id="dialogueText"></p>
        <div class="click-hint">ç‚¹å‡»ç»§ç»­</div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="uiLayer">
        <div id="gameTitle" style="color:white; font-size:36px; font-weight:bold; margin-bottom:30px; text-shadow:2px 2px 4px black;">ã€Šéœ‰è±†è…æ‘Šä¸»æ¨¡æ‹Ÿå™¨ã€‹</div>
        
        <div id="resultCard">
            <div style="font-size:60px;">ğŸ</div>
            <h2 id="res-name" style="color:#d32f2f; margin:15px 0; font-size:28px;">è£…ç½å®Œæˆ</h2>
            <div style="text-align:left; background:#f5f5f5; padding:20px; border-radius:10px; color:#555; font-size:18px;">
                <p>é¡¾å®¢è¦æ±‚ï¼š<span id="res-req" style="font-weight:bold; color:#1565c0;">--</span></p>
                <p>æ‚¨çš„é…æ–¹ï¼š<span id="res-mix" style="font-weight:bold; color:#2e7d32;">--</span></p>
                <p>è£…ç½æ•°é‡ï¼š<span id="res-count" style="font-weight:bold;">0</span> å—</p>
            </div>
            <button class="game-btn" onclick="location.reload()" style="margin-top:25px; width:100%;">å†æ¥ä¸€å±€</button>
        </div>

        <button id="actionBtn" class="game-btn">å¼€å§‹è¥ä¸š</button>
    </div>

</div>

<script>
    // å…¨å±€çŠ¶æ€
    const state = {
        s3Step: 0, customerReq: null, playerMix: [],
        shakeVal: 0, isShaking: false, 
        currentFilterClass: 'filter-red',
        jar: { count: 0, placedPieces: [] },
        dialogueQueue: [],
        isDialoguePlaying: false,
        currentDialogueAudio: null,
        bgmEnabled: true,
        saltAdded: false // é£Ÿç›æ˜¯å¦å·²æ·»åŠ 
    };

    // é¡¾å®¢å›ç­”è®¾å®šï¼šä¸€å…±è®¾å®šäº†5ç§ä¸åŒçš„å›ç­”
    const SCENARIOS = [
        { 
            text: "å¾®è¾£ï¼ŒåŠ èŠ±æ¤’", 
            targets: ['item-pepper'], 
            label: "å¾®è¾£(èŠ±æ¤’)",
            audio: "sound/dialogue_customer_1.mp3"
        },
        { 
            text: "æ™®é€šè¾£", 
            targets: ['item-chili'], 
            label: "é¦™è¾£",
            audio: "sound/dialogue_customer_2.mp3"
        },
        { 
            text: "ç‰¹è¾£ï¼éº»è¾£éƒ½è¦", 
            targets: ['item-pepper', 'item-chili'], 
            label: "éº»è¾£",
            audio: "sound/dialogue_customer_3.mp3"
        },
        { 
            text: "æˆ‘ä¸åƒè¾£ï¼Œæ¥ä¸ªäº”é¦™çš„", 
            targets: ['item-five'], 
            label: "äº”é¦™",
            audio: "sound/dialogue_customer_4.mp3"
        },
        { 
            text: "ç»™æˆ‘æ¥ä¸ªç»ˆæå˜æ€è¾£ï¼", 
            targets: ['item-pepper', 'item-chili', 'item-five'], 
            label: "å˜æ€è¾£",
            audio: "sound/dialogue_customer_5.mp3"
        }
    ];

    // å¯¹è¯é…ç½®æ–‡ä»¶
    const dialogueConfig = {
        "s1_1": { text: "æ‘Šä¸»ï¼šç¾å¥³è¦ä¸è¦ä¹°éœ‰è±†è…", role: "host", audio: "sound/dialogue_s1_1.mp3" },
        "s1_2": { text: "æ‘Šä¸»ï¼šè¯¶è¯¶è¯¶ï¼ä½ åˆ«æ‘¸å‘€ï¼ä½ æ‘¸äº†æˆ‘æ€ä¹ˆå–", role: "host", audio: "sound/dialogue_s1_2.mp3" },
        "s1_3": { text: "é¡¾å®¢ï¼šé‚£æˆ‘æ¥ä¸€æ¿å§", role: "customer", audio: "sound/dialogue_s1_3.mp3" },
        "s3_ask": { text: "æ‘Šä¸»ï¼šè¦å¾®è¾£ã€æ™®é€šè¾£ï¼Œè¿˜æ˜¯ç‰¹è¾£ï¼Ÿ", role: "host", audio: "sound/dialogue_s3_ask.mp3" },
        "s3_fail": { text: "é¡¾å®¢ï¼šè¿™ä¸æ˜¯æˆ‘è¦çš„ï¼Œæˆ‘ä¸ä¹°äº†ï¼", role: "customer", audio: "sound/dialogue_fail.mp3" }
    };

    // éŸ³é¢‘å¯¹è±¡
    const sounds = {
        click: new Audio('sound/click.mp3'),
        cut: new Audio('sound/cut.mp3'),
        cut_complete: new Audio('sound/cut_complete.mp3'),
        shake: new Audio('sound/shake.mp3'),
        drop: new Audio('sound/drop.mp3'),
        dialogue: new Audio('sound/dialogue.mp3'),
        complete: new Audio('sound/complete.mp3'),
        fail: new Audio('sound/fail.mp3')
    };

    // èƒŒæ™¯éŸ³ä¹
    const bgm = new Audio('sound/bgm.mp3');
    bgm.loop = true;
    bgm.volume = 0.3;

    // åˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹
    function initBGM() {
        // ç­‰å¾…ç”¨æˆ·äº¤äº’åæ’­æ”¾éŸ³ä¹
        const playBGM = () => {
            if (state.bgmEnabled) {
                bgm.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
            }
        };
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        document.addEventListener('click', playBGM, { once: true });
        document.addEventListener('touchstart', playBGM, { once: true });
        
        updateBGMButton();
    }

    // åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
    function toggleBGM() {
        state.bgmEnabled = !state.bgmEnabled;
        
        if (state.bgmEnabled) {
            bgm.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
        } else {
            bgm.pause();
        }
        
        updateBGMButton();
    }

    // æ›´æ–°èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’®
    function updateBGMButton() {
        const btn = document.getElementById('bgmControl');
        if (btn) {
            btn.innerHTML = state.bgmEnabled ? 'â™ª' : 'â™«';
            btn.title = state.bgmEnabled ? 'ç‚¹å‡»å…³é—­èƒŒæ™¯éŸ³ä¹' : 'ç‚¹å‡»å¼€å¯èƒŒæ™¯éŸ³ä¹';
        }
    }

    // é¢„åŠ è½½éŸ³é¢‘
    function preloadSounds() {
        for(let key in sounds) {
            sounds[key].load();
            sounds[key].volume = 0.6;
        }
    }

    // æ’­æ”¾éŸ³æ•ˆ
    function playSound(name) {
        if(sounds[name] && state.bgmEnabled) {
            sounds[name].currentTime = 0;
            sounds[name].play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
        }
    }

    // æ’­æ”¾å¯¹è¯é…éŸ³
    function playDialogueAudio(audioPath) {
        if (state.currentDialogueAudio) {
            state.currentDialogueAudio.pause();
            state.currentDialogueAudio.currentTime = 0;
        }
        
        if (audioPath) {
            state.currentDialogueAudio = new Audio(audioPath);
            state.currentDialogueAudio.volume = 0.7;
            state.currentDialogueAudio.play().catch(e => console.log("å¯¹è¯éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e));
        }
    }

    // æ˜¾ç¤ºéªŒè¯æç¤ºæ ‡ç­¾
    function showValidationTip(message) {
        const tip = document.getElementById('validationTip');
        tip.textContent = message;
        tip.style.display = 'block';
        playSound('click'); // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
        
        // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            tip.style.display = 'none';
        }, 2000);
    }

    const $ = (id) => document.getElementById(id);

    window.onload = () => {
        preloadSounds();
        initBGM();
        $('actionBtn').onclick = handleMainAction;
        $('btn-finish-cut').onclick = () => {
            playSound('click');
            showTransition("åˆ‡å‰²å®Œæˆ", "ä¸‹ä¸€æ­¥ï¼šæ‘‡æ™ƒè£¹æ–™ >>", startStage3);
        };
        $('btn-confirm-mix').onclick = validateMix;
        $('btn-finish-pack').onclick = showResult;
        
        $('dialogueBox').onclick = nextDialogue;
        
        // é˜²æ­¢æ‰‹æœºæµè§ˆå™¨ä¸‹æ‹‰åˆ·æ–°
        document.addEventListener('touchmove', function(e) {
            if(e.scale !== 1) { e.preventDefault(); }
        }, { passive: false });
    };

    function handleMainAction() {
        playSound('click');
        const txt = $('actionBtn').textContent;
        if (txt.includes("è¥ä¸š")) startStage1();
        else if (txt.includes("è£¹æ–™")) startStage3();
        else if (txt.includes("è£…ç½")) startStage4();
    }

    function showTransition(title, btnText, nextFunc) {
        $('uiLayer').style.display = 'flex';
        $('gameTitle').textContent = title;
        $('actionBtn').textContent = btnText;
        $('actionBtn').style.display = 'block';
        $('resultCard').style.display = 'none';
        $('actionBtn').onclick = nextFunc;
    }

    function hideAll() {
        ['stage1','stage2','stage3','stage4'].forEach(id => $(id).style.display = 'none');
        $('uiLayer').style.display = 'none';
    }

    // ================= å¯¹è¯ç³»ç»Ÿ =================
    
    function addToDialogueQueue(dialogueKey) {
        const dialogue = dialogueConfig[dialogueKey];
        if (dialogue) {
            state.dialogueQueue.push(dialogue);
            if (!state.isDialoguePlaying) {
                showNextDialogue();
            }
        } else {
            console.warn("æœªé…ç½®çš„å¯¹è¯:", dialogueKey);
        }
    }
    
    function showNextDialogue() {
        if (state.dialogueQueue.length === 0) {
            state.isDialoguePlaying = false;
            $('dialogueBox').style.display = 'none';
            
            if (state.dialogueCallback) {
                state.dialogueCallback();
                state.dialogueCallback = null;
            }
            return;
        }
        
        state.isDialoguePlaying = true;
        const dialogue = state.dialogueQueue.shift();
        
        showDialogue(dialogue.text, dialogue.role, dialogue.audio);
    }
    
    function nextDialogue() {
        if (state.isDialoguePlaying) {
            showNextDialogue();
        }
    }
    
    function showDialogue(txt, role, audioPath) {
        const d = $('dialogueBox'); 
        const text = $('dialogueText');
        text.textContent = txt;
        
        d.className = role === 'host' ? 'dialogue-host' : 'dialogue-customer';
        d.style.display = 'flex';
        
        if (audioPath) {
            playDialogueAudio(audioPath);
        } else {
            playSound('dialogue');
        }
    }
    
    function showSimpleDialogue(txt, role, audioKey) {
        const d = $('dialogueBox'); 
        const text = $('dialogueText');
        text.textContent = txt;
        
        d.className = role === 'host' ? 'dialogue-host' : 'dialogue-customer';
        d.style.display = 'flex';
        
        d.onclick = function() {
            $('dialogueBox').style.display = 'none';
            d.onclick = nextDialogue;
        };
        
        if (audioKey && sounds[audioKey]) {
            playSound(audioKey);
        } else {
            playSound('dialogue');
        }
    }

    // --- S1: å‰§æƒ…äº’åŠ¨ ---
    function startStage1() {
        hideAll(); $('stage1').style.display = 'block';
        const hand = $('customerHand');
        hand.className = ''; void hand.offsetWidth;
        
        state.dialogueQueue = [];
        
        addToDialogueQueue("s1_1");
        
        state.dialogueCallback = () => {
            hand.classList.add('hand-anim-in');
            
            let clicked = false;
            const clickHandler = (e) => {
                if (clicked) return;
                e.preventDefault();
                if (hand.classList.contains('hand-anim-in')) {
                    clicked = true;
                    hand.classList.remove('hand-anim-in');
                    const s = window.getComputedStyle(hand);
                    hand.style.right = s.right; hand.style.top = s.top;

                    addToDialogueQueue("s1_2");
                    addToDialogueQueue("s1_3");
                    
                    state.dialogueCallback = () => {
                        hand.classList.add('hand-anim-out');
                        setTimeout(() => {
                            $('dialogueBox').style.display = 'none';
                            startStage2();
                        }, 300);
                    };
                }
            };
            
            hand.addEventListener('touchstart', clickHandler, {passive:false});
            hand.addEventListener('mousedown', clickHandler);
        };
    }

    // --- S2: åˆ‡å‰² ---
    function startStage2() {
        hideAll(); $('stage2').style.display = 'block';
        $('cuttingBoard').style.backgroundImage = "url('img/tofu_raw.png')";
        
        const cvs = $('cutCanvas'); const ctx = cvs.getContext('2d');
        ctx.clearRect(0,0,350,350);
        ctx.strokeStyle = '#ffeb3b'; ctx.lineWidth = 4; ctx.lineCap = 'round';
        let isD = false, cutC = 0;
        let cutCompleteSoundPlayed = false; // æ ‡è®°åˆ‡å‰²å®ŒæˆéŸ³æ•ˆæ˜¯å¦å·²æ’­æ”¾

        const getP = (e) => {
            const r = cvs.getBoundingClientRect();
            const x = e.touches?e.touches[0].clientX:e.clientX;
            const y = e.touches?e.touches[0].clientY:e.clientY;
            return {x:x-r.left, y:y-r.top};
        };

        const start = (e) => { 
            e.preventDefault(); 
            isD=true; 
            ctx.beginPath(); 
            const p=getP(e); 
            ctx.moveTo(p.x, p.y); 
        };
        const move = (e) => { 
            if(!isD)return; 
            e.preventDefault(); 
            const p=getP(e); 
            ctx.lineTo(p.x, p.y); 
            ctx.stroke(); 
            if(Math.random() < 0.3) playSound('cut');
        };
        const end = () => { 
            if(isD){ 
                isD=false; cutC++; 
                if(cutC>=4) { 
                    $('cuttingBoard').style.backgroundImage = "url('img/board.png')";
                    $('btn-finish-cut').style.display='block'; 
                    
                    // åœ¨å®Œæˆ4åˆ€æ—¶ç«‹å³æ’­æ”¾éŸ³æ•ˆ
                    if (!cutCompleteSoundPlayed) {
                        playSound('cut_complete');
                        cutCompleteSoundPlayed = true;
                    }
                }
            } 
        };

        cvs.addEventListener('touchstart', start, {passive:false});
        cvs.addEventListener('touchmove', move, {passive:false});
        cvs.addEventListener('touchend', end);
        cvs.addEventListener('mousedown', start);
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
    }

    // --- S3: è£¹æ–™ ---
    function startStage3() {
        hideAll(); $('stage3').style.display = 'block';
        state.playerMix = []; state.s3Step = 0; state.saltAdded = false;
        $('orderNote').style.display = 'none';
        const pot = $('mixingPot'); pot.innerHTML = '';
        
        for(let i=0; i<12; i++) {
            let d = document.createElement('div');
            d.className = 'tofu-cube';
            let left = 190 + (Math.random()*120 - 60) - 40; 
            let top = 190 + (Math.random()*120 - 60) - 40;
            d.style.left = left + 'px';
            d.style.top = top + 'px';
            d.style.transform = `rotate(${Math.random()*360}deg)`;
            pot.appendChild(d);
        }
        updateS3UI(0);
    }

    function updateS3UI(step) {
        state.s3Step = step;
        const guide = $('s3-guide');
        ['item-spirit','item-pepper','item-five','item-chili','item-salt'].forEach(id=>{
            const el = $(id); el.className = 'seasoning-item'; el.onclick = null;
        });

        if (step===0) {
            guide.textContent = "æ­¥éª¤1: ç‚¹å‡»ã€ç™½é…’ã€‘æ€èŒ";
            const btn = $('item-spirit'); btn.classList.add('clickable');
            btn.onclick = () => {
                playSound('click');
                btn.classList.remove('clickable'); btn.classList.add('selected');
                runShake("å·²åŠ ç™½é…’ï¼Œæ‘‡æ™ƒæ‹ŒåŒ€ï¼", () => {
                    document.querySelectorAll('.tofu-cube').forEach(c => c.classList.add('filter-wet'));
                    triggerCustomer();
                });
            };
        } else if (step===1) {
            // å°†é£Ÿç›å’Œå…¶ä»–é…æ–™æ”¾åœ¨åŒä¸€æ­¥éª¤
            guide.textContent = "æ­¥éª¤2: æ ¹æ®é¡¾å®¢è¦æ±‚é€‰æ–™ï¼Œæœ€ååŠ ã€é£Ÿç›ã€‘";
            // æ‰€æœ‰è°ƒæ–™éƒ½å¯ä»¥ç‚¹å‡»
            ['item-pepper','item-chili','item-five','item-salt'].forEach(id=>{
                const btn = $(id); btn.classList.add('clickable');
                btn.onclick = () => {
                    playSound('click');
                    
                    if (id === 'item-salt') {
                        // é£Ÿç›åªéœ€æ·»åŠ ä¸€æ¬¡
                        if (!state.saltAdded) {
                            btn.classList.add('selected');
                            state.playerMix.push(id);
                            state.saltAdded = true;
                        }
                    } else {
                        // å…¶ä»–è°ƒæ–™å¯ä»¥åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                        btn.classList.toggle('selected');
                        if (state.playerMix.includes(id)) {
                            state.playerMix = state.playerMix.filter(x=>x!==id);
                        } else {
                            state.playerMix.push(id);
                        }
                    }
                };
            });
            $('btn-confirm-mix').style.display='block';
        }
    }

    function triggerCustomer() {
        state.customerReq = SCENARIOS[Math.floor(Math.random()*SCENARIOS.length)];
        
        state.dialogueQueue = [];
        
        addToDialogueQueue("s3_ask");
        
        const customerResponse = {
            text: "é¡¾å®¢ï¼š" + state.customerReq.text,
            role: "customer",
            audio: state.customerReq.audio
        };
        
        state.dialogueQueue.push(customerResponse);
        
        state.dialogueCallback = () => {
            $('dialogueBox').style.display = 'none';
            $('orderNote').textContent = "è®¢å•: " + state.customerReq.text;
            $('orderNote').style.display = 'block';
            updateS3UI(1);
        };
        
        if (!state.isDialoguePlaying) {
            showNextDialogue();
        }
    }

    function validateMix() {
        // æ£€æŸ¥æ˜¯å¦è‡³å°‘é€‰æ‹©äº†ä¸€ç§è°ƒæ–™ï¼ˆä¸åŒ…æ‹¬é£Ÿç›ï¼‰
        const nonSaltSelections = state.playerMix.filter(id => id !== 'item-salt');
        if(nonSaltSelections.length===0){ 
            // ä½¿ç”¨éªŒè¯æç¤ºæ ‡ç­¾è€Œä¸æ˜¯å¯¹è¯æ¡†
            showValidationTip("è‡³å°‘æ”¾ç‚¹æ–™å§ï¼");
            return; 
        }
        
        // æ£€æŸ¥æ˜¯å¦åŠ äº†é£Ÿç›
        if (!state.saltAdded) {
            // ä½¿ç”¨éªŒè¯æç¤ºæ ‡ç­¾è€Œä¸æ˜¯å¯¹è¯æ¡†
            showValidationTip("åˆ«å¿˜äº†åŠ é£Ÿç›ï¼");
            return;
        }
        
        $('btn-confirm-mix').style.display='none';
        
        state.currentFilterClass = "filter-red";

        runShake("æ‘‡æ™ƒè£¹ç²‰ï¼", () => {
            document.querySelectorAll('.tofu-cube').forEach(c => {
                c.classList.remove('filter-wet');
                c.classList.add(state.currentFilterClass);
            });
            // ç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥
            setTimeout(() => showTransition("è…Œåˆ¶å®Œæˆ", "ä¸‹ä¸€æ­¥ï¼šåˆ›æ„è£…ç½ >>", startStage4), 800);
        });
    }

    function runShake(msg, cb) {
        state.isShaking = true; state.shakeVal = 0;
        $('s3-guide').textContent = msg; $('progressContainer').style.display = 'block';
        
        $('mixingPot').classList.add('shake-pot-anim');
        document.querySelectorAll('.tofu-cube').forEach(c => c.classList.add('shake-inner'));

        playSound('shake');

        const update = () => {
            if(!state.isShaking) return;
            state.shakeVal+=5; $('shakeProgressBar').style.width=state.shakeVal+'%';
            if(state.shakeVal>=100){
                state.isShaking=false; 
                $('mixingPot').classList.remove('shake-pot-anim');
                document.querySelectorAll('.tofu-cube').forEach(c => c.classList.remove('shake-inner'));
                $('progressContainer').style.display='none'; $('shakeProgressBar').style.width='0%'; 
                cb();
            }
        };

        const pot = $('mixingPot');
        pot.addEventListener('touchmove', (e)=>{e.preventDefault(); update();}, {passive:false});
        pot.addEventListener('mousemove', (e)=>{if(e.buttons===1) update();});
        window.ondevicemotion = (e) => {
            let acc = e.accelerationIncludingGravity;
            if(state.isShaking && acc && (Math.abs(acc.x)>15 || Math.abs(acc.y)>15)) update();
        };
    }

    // --- S4: è£…ç½ ---
    function startStage4() {
        hideAll(); $('stage4').style.display = 'block';
        const src = $('s4-pot-area'); src.innerHTML = '';
        state.jar.count = 0;
        state.jar.placedPieces = [];

        const oldInner = document.querySelectorAll('.jar-tofu-inner');
        oldInner.forEach(el => el.remove());

        for(let i=0; i<10; i++) {
            let t = document.createElement('div'); t.className = 'pack-tofu';
            t.classList.add(state.currentFilterClass);
            let left = 190 + (Math.random()*100 - 50) - 40; 
            let top = 190 + (Math.random()*100 - 50) - 40;
            t.style.left = left+'px'; t.style.top = top+'px';
            t.style.transform = `rotate(${Math.random()*360}deg)`;
            
            enableDrag(t); src.appendChild(t);
        }
    }

    function enableDrag(el) {
        let isD=false, startX, startY;
        const start = (e) => {
            e.preventDefault(); isD=true; const p=e.touches?e.touches[0]:e;
            const r = el.getBoundingClientRect();
            startX=p.clientX-r.left; startY=p.clientY-r.top;
            el.classList.add('dragging');
            el.style.left=r.left+'px'; el.style.top=r.top+'px'; 
            document.body.appendChild(el);
        };
        const move = (e) => {
            if(!isD) return; e.preventDefault(); const p=e.touches?e.touches[0]:e;
            el.style.left=(p.clientX-startX)+'px'; el.style.top=(p.clientY-startY)+'px';
            checkHover(el);
        };
        const end = () => {
            if(!isD) return; isD=false; el.classList.remove('dragging');
            if(checkDrop(el)) { 
                el.remove(); 
                addTofuToJar(); 
                playSound('drop');
            } else {
                const src = $('s4-pot-area'); src.appendChild(el);
                let left = 190 + (Math.random()*100 - 50) - 40; 
                let top = 190 + (Math.random()*100 - 50) - 40;
                el.style.left=left+'px'; el.style.top=top+'px';
            }
            $('theJar').classList.remove('highlight');
        };
        el.addEventListener('touchstart', start, {passive:false});
        el.addEventListener('touchmove', move, {passive:false});
        el.addEventListener('touchend', end);
        el.addEventListener('mousedown', start);
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
    }

    function checkHover(el) {
        const r = el.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2;
        const jar = $('theJar'); const jr = jar.getBoundingClientRect();
        if(cx>jr.left && cx<jr.right && cy>jr.top && cy<jr.bottom) jar.classList.add('highlight');
        else jar.classList.remove('highlight');
    }

    function checkDrop(el) {
        const r = el.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2;
        const jr = $('theJar').getBoundingClientRect();
        return (cx>jr.left && cx<jr.right && cy>jr.top && cy<jr.bottom);
    }

    function addTofuToJar() {
        // ç½å­å®¹é‡é™åˆ¶æ”¹ä¸º10å—
        if (state.jar.count >= 10) {
            showValidationTip("ç½å­å·²ç»æ»¡äº†ï¼");
            return;
        }
        
        state.jar.count++;
        const jarBox = $('theJar');
        
        let inner = document.createElement('div');
        inner.className = 'jar-tofu-inner';
        inner.classList.add(state.currentFilterClass);
        
        // æ”¹è¿›çš„ç½‘æ ¼æ”¾ç½®ç®—æ³•ï¼Œç¡®ä¿è±†è…ä¸è¶…å‡ºç½å­èŒƒå›´
        const gridSize = 60;
        const jarWidth = 220;
        const jarHeight = 280;
        const padding = 20;
        
        const cols = Math.floor((jarWidth - padding * 2) / gridSize);
        const rows = Math.floor((jarHeight - padding * 2) / gridSize);
        const maxCapacity = cols * rows;
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç©ºé—´
        if (state.jar.placedPieces.length >= maxCapacity) {
            showValidationTip("ç½å­å·²ç»æ»¡äº†ï¼");
            state.jar.count--;
            return;
        }
        
        let placed = false;
        // å°è¯•æ”¾ç½®åˆ°ç½‘æ ¼ä½ç½®
        for (let row = 0; row < rows && !placed; row++) {
            for (let col = 0; col < cols && !placed; col++) {
                const posKey = `${row},${col}`;
                if (!state.jar.placedPieces.includes(posKey)) {
                    const left = padding + col * gridSize;
                    const bottom = padding + row * gridSize;
                    
                    inner.style.left = left + 'px';
                    inner.style.bottom = bottom + 'px';
                    inner.style.transform = `rotate(${Math.random()*20-10}deg) scale(0.85)`;
                    
                    state.jar.placedPieces.push(posKey);
                    placed = true;
                }
            }
        }
        
        // å¦‚æœç½‘æ ¼æ”¾æ»¡äº†ï¼Œéšæœºæ”¾ç½®ï¼ˆä½†ç¡®ä¿åœ¨ç½å­èŒƒå›´å†…ï¼‰
        if (!placed) {
            const maxLeft = jarWidth - gridSize - padding;
            const maxBottom = jarHeight - gridSize - padding;
            
            const left = padding + Math.random() * maxLeft;
            const bottom = padding + Math.random() * maxBottom;
            
            inner.style.left = left + 'px';
            inner.style.bottom = bottom + 'px';
            inner.style.transform = `rotate(${Math.random()*20-10}deg) scale(0.8)`;
        }
        
        jarBox.appendChild(inner);
    }

    function showResult() {
        if(state.jar.count===0) { 
            showSimpleDialogue("è¿˜æ²¡è£…ç½å‘¢ï¼", 'host', 'dialogue');
            return; 
        }
        
        // æ£€æŸ¥æ˜¯å¦æŒ‰ç…§å®¢äººçš„è¦æ±‚å®Œæˆ
        let isCorrect = false;
        if (state.customerReq && state.playerMix) {
            // ç§»é™¤é£Ÿç›ï¼Œå› ä¸ºé£Ÿç›æ˜¯å¿…é¡»çš„ä½†ä¸å½±å“å£å‘³åˆ¤æ–­
            const playerTargetsWithoutSalt = state.playerMix.filter(id => id !== 'item-salt');
            const requiredTargets = state.customerReq.targets;
            
            // æ£€æŸ¥ä¸¤ä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ç›¸åŒçš„å…ƒç´ ï¼ˆé¡ºåºä¸é‡è¦ï¼‰
            if (playerTargetsWithoutSalt.length === requiredTargets.length) {
                isCorrect = playerTargetsWithoutSalt.every(item => requiredTargets.includes(item)) &&
                           requiredTargets.every(item => playerTargetsWithoutSalt.includes(item));
            }
        }
        
        if (!isCorrect) {
            // åˆ¶ä½œå¤±è´¥
            playSound('fail');
            
            state.dialogueQueue = [];
            
            state.dialogueQueue.push({
                text: "é¡¾å®¢ï¼šè¿™ä¸æ˜¯æˆ‘è¦çš„ï¼Œæˆ‘ä¸ä¹°äº†ï¼",
                role: "customer",
                audio: "sound/dialogue_fail.mp3"
            });
            
            state.dialogueCallback = () => {
                $('dialogueBox').style.display = 'none';
                $('uiLayer').style.display='flex'; $('gameTitle').style.display='none';
                $('actionBtn').style.display='none'; $('resultCard').style.display='block';
                $('res-name').textContent = "åˆ¶ä½œå¤±è´¥";
                $('res-name').style.color = "#d32f2f";
                $('res-req').textContent = state.customerReq?state.customerReq.label:"æ— ";
                $('res-count').textContent = state.jar.count;
                let mix = "è‡ªåˆ›";
                if(state.playerMix.includes('item-chili')) mix="é¦™è¾£";
                if(state.playerMix.includes('item-pepper') && state.playerMix.includes('item-chili')) mix="éº»è¾£";
                if(state.playerMix.includes('item-five')) mix="äº”é¦™";
                $('res-mix').textContent = mix + " (å·²åŠ ç›)";
            };
            
            if (!state.isDialoguePlaying) {
                showNextDialogue();
            }
        } else {
            // åˆ¶ä½œæˆåŠŸ
            playSound('click');
            playSound('complete');
            
            $('uiLayer').style.display='flex'; $('gameTitle').style.display='none';
            $('actionBtn').style.display='none'; $('resultCard').style.display='block';
            $('res-name').textContent = "è£…ç½å®Œæˆ";
            $('res-name').style.color = "#2e7d32";
            $('res-req').textContent = state.customerReq?state.customerReq.label:"æ— ";
            $('res-count').textContent = state.jar.count;
            let mix = "è‡ªåˆ›";
            if(state.playerMix.includes('item-chili')) mix="é¦™è¾£";
            if(state.playerMix.includes('item-pepper') && state.playerMix.includes('item-chili')) mix="éº»è¾£";
            if(state.playerMix.includes('item-five')) mix="äº”é¦™";
            $('res-mix').textContent = mix + " (å·²åŠ ç›)";
        }
    }
    
    // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    window.toggleBGM = toggleBGM;
    
    // æ·»åŠ PWAæ”¯æŒï¼ˆå¯é€‰ï¼‰
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js').catch(function(error) {
                console.log('ServiceWorker registration failed: ', error);
            });
        });
    }
</script>
</body>
</html>